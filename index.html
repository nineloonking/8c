<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>命格運勢五行形意</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 10px;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #canvas {
            border: 1px solid #ccc;
            width: 350px;
            height: 350px;
        }
        .controls {
            margin-top: 15px;
            width: 100%;
            max-width: 350px;
        }
        select {
            width: 100%;
            padding: 5px;
            font-size: 16px;
        }
        table {
            border-collapse: collapse;
            margin-top: 10px;
            width: 100%;
            max-width: 350px;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: center;
            font-size: 14px;
        }
        select.number-select, select.fortune-select, select.year-select {
            width: 60px;
        }
        .checkbox-container {
            margin-top: 10px;
            font-size: 14px;
        }
        #fortuneHeader {
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h2>命格運勢五行形意</h2>
    <canvas id="canvas" width="350" height="350"></canvas>
    <div class="controls">
        <label for="orderSelect">五行順序：</label>
        <select id="orderSelect" onchange="updateCanvas()">
            <option value="金水木火土">金水木火土 (預設)</option>
            <option value="土金水木火">土金水木火</option>
            <option value="火土金水木">火土金水木</option>
            <option value="木火土金水">木火土金水</option>
            <option value="水木火土金">水木火土金</option>
        </select>
        <div class="checkbox-container">
            <input type="checkbox" id="limitSum" checked onchange="updateNumberSelects(); updateFortuneSelects(); updateYearSelects(); updateCanvas()">
            <label for="limitSum">限制命格運勢總和</label>
        </div>
    </div>
    <table>
        <thead>
            <tr>
                <th>五行</th>
                <th>位置</th>
                <th>命格</th>
                <th id="fortuneHeader" onclick="toggleFortuneMode()">大運(干)</th>
                <th>流年</th>
            </tr>
        </thead>
        <tbody id="tableBody">
            <tr><td id="element1">木</td><td id="position1"></td><td><select id="number1" class="number-select" onchange="updateNumberSelects(); updateCanvas()"></select></td><td><select id="fortune1" class="fortune-select" onchange="updateFortuneSelects(); updateCanvas()"></select></td><td><select id="year1" class="year-select" onchange="updateYearSelects(); updateCanvas()"></select></td></tr>
            <tr><td id="element2">火</td><td id="position2"></td><td><select id="number2" class="number-select" onchange="updateNumberSelects(); updateCanvas()"></select></td><td><select id="fortune2" class="fortune-select" onchange="updateFortuneSelects(); updateCanvas()"></select></td><td><select id="year2" class="year-select" onchange="updateYearSelects(); updateCanvas()"></select></td></tr>
            <tr><td id="element3">土</td><td id="position3"></td><td><select id="number3" class="number-select" onchange="updateNumberSelects(); updateCanvas()"></select></td><td><select id="fortune3" class="fortune-select" onchange="updateFortuneSelects(); updateCanvas()"></select></td><td><select id="year3" class="year-select" onchange="updateYearSelects(); updateCanvas()"></select></td></tr>
            <tr><td id="element4">金</td><td id="position4"></td><td><select id="number4" class="number-select" onchange="updateNumberSelects(); updateCanvas()"></select></td><td><select id="fortune4" class="fortune-select" onchange="updateFortuneSelects(); updateCanvas()"></select></td><td><select id="year4" class="year-select" onchange="updateYearSelects(); updateCanvas()"></select></td></tr>
            <tr><td id="element5">水</td><td id="position5"></td><td><select id="number5" class="number-select" onchange="updateNumberSelects(); updateCanvas()"></select></td><td><select id="fortune5" class="fortune-select" onchange="updateFortuneSelects(); updateCanvas()"></select></td><td><select id="year5" class="year-select" onchange="updateYearSelects(); updateCanvas()"></select></td></tr>
        </tbody>
    </table>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const orderSelect = document.getElementById('orderSelect');
        const limitSumCheckbox = document.getElementById('limitSum');
        const fortuneHeader = document.getElementById('fortuneHeader');
        const numberSelects = [
            document.getElementById('number1'),
            document.getElementById('number2'),
            document.getElementById('number3'),
            document.getElementById('number4'),
            document.getElementById('number5')
        ];
        const fortuneSelects = [
            document.getElementById('fortune1'),
            document.getElementById('fortune2'),
            document.getElementById('fortune3'),
            document.getElementById('fortune4'),
            document.getElementById('fortune5')
        ];
        const yearSelects = [
            document.getElementById('year1'),
            document.getElementById('year2'),
            document.getElementById('year3'),
            document.getElementById('year4'),
            document.getElementById('year5')
        ];
        const elementCells = [
            document.getElementById('element1'),
            document.getElementById('element2'),
            document.getElementById('element3'),
            document.getElementById('element4'),
            document.getElementById('element5')
        ];
        const positionCells = [
            document.getElementById('position1'),
            document.getElementById('position2'),
            document.getElementById('position3'),
            document.getElementById('position4'),
            document.getElementById('position5')
        ];

        // 五行顏色對應
        const elementColors = {
            '木': '#00cc00',
            '土': '#ffcc00',
            '金': '#cccccc',
            '火': '#ff3333',
            '水': '#333333'
        };

        // 屬性文字對應
        const attributeTexts = [
            '比劫', // 一位
            '食傷', // 二位
            '財才', // 三位
            '官殺', // 四位
            '印梟'  // 五位
        ];

        // 固定五行順序
        const fixedElements = ['木', '火', '土', '金', '水'];

        // 粗體規則
        const boldElements = {
            '金水木火土': ['金', '土'],
            '土金水木火': ['土', '火'],
            '火土金水木': ['火', '木'],
            '木火土金水': ['木', '水'],
            '水木火土金': ['水', '金']
        };

        // 大運模式
        let fortuneMode = 'stem'; // 'stem' (干) 或 'branch' (支)

        // 切換大運模式
        function toggleFortuneMode() {
            fortuneMode = fortuneMode === 'stem' ? 'branch' : 'stem';
            fortuneHeader.textContent = fortuneMode === 'stem' ? '大運(干)' : '大運(支)';
            updateFortuneSelects();
            updateCanvas();
        }

        // 初始化命格下拉選單 (0-60)
        function initNumberSelects() {
            updateNumberSelects();
            // 預設值根據 fixedElements 順序（木, 火, 土, 金, 水）
            // 但需映射到 orderSelect 的初始值（金水木火土）
            const defaultOrder = '金水木火土';
            const defaultValues = { '金': 7, '水': 26, '木': 16, '火': 6, '土': 5 };
            const order = defaultOrder.split('');
            for (let i = 0; i < fixedElements.length; i++) {
                const element = fixedElements[i];
                const indexInOrder = order.indexOf(element);
                numberSelects[i].value = defaultValues[element] || 0;
            }
            updateNumberSelects();
        }

        // 初始化大運和流年下拉選單
        function initFortuneYearSelects() {
            updateFortuneSelects();
            updateYearSelects();
            for (let i = 0; i < fortuneSelects.length; i++) {
                fortuneSelects[i].value = 0;
                yearSelects[i].value = 0;
            }
        }

        // 更新命格下拉選單選項
        function updateNumberSelects() {
            const limitSum = limitSumCheckbox.checked;
            const currentValues = numberSelects.map(select => parseInt(select.value) || 0);

            for (let i = 0; i < numberSelects.length; i++) {
                const select = numberSelects[i];
                const currentValue = currentValues[i];
                select.innerHTML = '';
                const otherSum = currentValues.reduce((sum, val, idx) => idx !== i ? sum + val : sum, 0);
                const maxValue = limitSum ? Math.min(60 - otherSum, 60) : 60;
                for (let j = 0; j <= maxValue; j++) {
                    const option = document.createElement('option');
                    option.value = j;
                    option.text = j;
                    select.appendChild(option);
                }
                select.value = Math.min(currentValue, maxValue);
            }
        }

        // 更新大運下拉選單選項
        function updateFortuneSelects() {
            const limitSum = limitSumCheckbox.checked;
            const currentValues = fortuneSelects.map(select => parseInt(select.value) || 0);
            const maxRange = fortuneMode === 'stem' ? 18 : 21;
            const maxSum = fortuneMode === 'stem' ? 18 : 21;

            for (let i = 0; i < fortuneSelects.length; i++) {
                const select = fortuneSelects[i];
                const currentValue = currentValues[i];
                select.innerHTML = '';
                const otherSum = currentValues.reduce((sum, val, idx) => idx !== i ? sum + val : sum, 0);
                const maxValue = limitSum ? Math.min(maxSum - otherSum, maxRange) : maxRange;
                for (let j = 0; j <= maxValue; j++) {
                    const option = document.createElement('option');
                    option.value = j;
                    option.text = j;
                    select.appendChild(option);
                }
                select.value = Math.min(currentValue, maxValue);
            }
        }

        // 更新流年下拉選單選項
        function updateYearSelects() {
            const limitSum = limitSumCheckbox.checked;
            const currentValues = yearSelects.map(select => parseInt(select.value) || 0);

            for (let i = 0; i < yearSelects.length; i++) {
                const select = yearSelects[i];
                const currentValue = currentValues[i];
                select.innerHTML = '';
                const otherSum = currentValues.reduce((sum, val, idx) => idx !== i ? sum + val : sum, 0);
                const maxValue = limitSum ? Math.min(13 - otherSum, 13) : 13;
                for (let j = 0; j <= maxValue; j++) {
                    const option = document.createElement('option');
                    option.value = j;
                    option.text = j;
                    select.appendChild(option);
                }
                select.value = Math.min(currentValue, maxValue);
            }
        }

        // 計算坐標
        function calculatePositions(radii) {
            const maxDistance = 150; // 限制最大距離以避免嚴重超出畫布
            const distances = [
                0, // 一位
                2 * radii[0] + 2 * radii[4] - radii[1], // 二位
                (2 * radii[0] + 2 * radii[4] - radii[2]) * 1.618, // 三位
                (2 * radii[0] + 2 * radii[4] - radii[3]) * 1.618, // 四位
                4 * radii[0] - radii[4] // 五位
            ];
            // 限制最大距離
            for (let i = 1; i < distances.length; i++) {
                distances[i] = Math.min(distances[i], maxDistance);
            }
            return [
                { x: 175, y: 225 }, // 一位：畫布中間下方
                { x: 175 - distances[1] * Math.cos(36 * Math.PI / 180), y: 225 - distances[1] * Math.sin(36 * Math.PI / 180) }, // 二位：左方偏上
                { x: 175 - distances[2] * Math.cos(72 * Math.PI / 180), y: 225 - distances[2] * Math.sin(72 * Math.PI / 180) }, // 三位：左上偏上
                { x: 175 + distances[3] * Math.cos(72 * Math.PI / 180), y: 225 - distances[3] * Math.sin(72 * Math.PI / 180) }, // 四位：右上偏上
                { x: 175 + distances[4] * Math.cos(36 * Math.PI / 180), y: 225 - distances[4] * Math.sin(36 * Math.PI / 180) } // 五位：右方偏上
            ];
        }

        // 更新表格和畫布
        function updateCanvas() {
            const order = orderSelect.value.split('');
            const numbers = numberSelects.map(select => parseInt(select.value) || 0);
            const fortunes = fortuneSelects.map(select => parseInt(select.value) || 0);
            const years = yearSelects.map(select => parseInt(select.value) || 0);

            // 表格：固定五行順序，動態位置
            const positionLabels = ['一位', '二位', '三位', '四位', '五位'];
            for (let i = 0; i < fixedElements.length; i++) {
                const element = fixedElements[i];
                const indexInOrder = order.indexOf(element);
                positionCells[i].textContent = positionLabels[indexInOrder];
                // 設置粗體
                elementCells[i].style.fontWeight = boldElements[orderSelect.value].includes(element) ? 'bold' : 'normal';
            }

            // 畫布：根據 order 順序計算
            const mappedNumbers = new Array(5).fill(0);
            const mappedFortunes = new Array(5).fill(0);
            const mappedYears = new Array(5).fill(0);
            for (let i = 0; i < fixedElements.length; i++) {
                const element = fixedElements[i];
                const indexInOrder = order.indexOf(element);
                mappedNumbers[indexInOrder] = numbers[i];
                mappedFortunes[indexInOrder] = fortunes[i];
                mappedYears[indexInOrder] = years[i];
            }
            const totalAreas = mappedNumbers.map((n, i) => n + mappedFortunes[i] + mappedYears[i]);
            const radii = totalAreas.map(area => Math.sqrt(area / Math.PI) * 15);
            const positions = calculatePositions(radii);

            const dpr = window.devicePixelRatio || 1;
            canvas.width = 350 * dpr;
            canvas.height = 350 * dpr;
            ctx.scale(dpr, dpr);

            ctx.clearRect(0, 0, 350, 350);

            ctx.beginPath();
            ctx.strokeStyle = '#00FF00';
            ctx.lineWidth = 2;
            const generateOrder = [0, 1, 2, 3, 4, 0];
            for (let i = 0; i < generateOrder.length - 1; i++) {
                const start = positions[generateOrder[i]];
                const end = positions[generateOrder[i + 1]];
                const midX = (start.x + end.x) / 2;
                const midY = (start.y + end.y) / 2;
                const dx = end.x - start.x;
                const dy = end.y - start.y;
                const controlX = midX + dy * 0.2;
                const controlY = midY - dx * 0.2;
                ctx.moveTo(start.x, start.y);
                ctx.quadraticCurveTo(controlX, controlY, end.x, end.y);
            }
            ctx.stroke();

            ctx.beginPath();
            ctx.strokeStyle = '#FF0000';
            ctx.lineWidth = 2;
            const restrainOrder = [0, 2, 4, 1, 3, 0];
            for (let i = 0; i < restrainOrder.length - 1; i++) {
                ctx.moveTo(positions[restrainOrder[i]].x, positions[restrainOrder[i]].y);
                ctx.lineTo(positions[restrainOrder[i + 1]].x, positions[restrainOrder[i + 1]].y);
            }
            ctx.stroke();

            for (let i = 0; i < 5; i++) {
                ctx.beginPath();
                ctx.arc(positions[i].x, positions[i].y, radii[i], 0, 2 * Math.PI);
                ctx.fillStyle = elementColors[order[i]];
                ctx.fill();

                ctx.fillStyle = '#FFFFFF';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.font = '14px Arial';
                ctx.fillText(order[i], positions[i].x, positions[i].y - 6);
                ctx.font = '12px Arial';
                ctx.fillText(attributeTexts[i], positions[i].x, positions[i].y + 12);
            }
        }

        // 初始化
        initNumberSelects();
        initFortuneYearSelects();
        updateCanvas();
    </script>
</body>
</html>
